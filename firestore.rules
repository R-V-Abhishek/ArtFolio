rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    // Users collection - users can read/write their own data
    match /users/{userId} {
      allow read: if request.auth != null;
      allow write, delete: if request.auth != null && request.auth.uid == userId;
      allow create: if request.auth != null; // Allow account creation
    }
    
    // Role-specific collections - linked to users
    match /artists/{artistId} {
      allow read: if request.auth != null;
      allow write, delete: if request.auth != null && request.auth.uid == artistId;
      allow create: if request.auth != null; // Allow profile creation
    }
    
    match /audiences/{audienceId} {
      allow read: if request.auth != null;
      allow write, delete: if request.auth != null && request.auth.uid == audienceId;
      allow create: if request.auth != null; // Allow profile creation
    }
    
    match /sponsors/{sponsorId} {
      allow read: if request.auth != null;
      allow write, delete: if request.auth != null && request.auth.uid == sponsorId;
      allow create: if request.auth != null; // Allow profile creation
    }
    
    match /organisations/{organisationId} {
      allow read: if request.auth != null;
      allow write, delete: if request.auth != null && request.auth.uid == organisationId;
      allow create: if request.auth != null; // Allow profile creation
    }
    
    // Posts collection - fixed rules for posting and deletion
    match /posts/{postId} {
      allow read: if request.auth != null;
      allow create: if request.auth != null && request.auth.uid == request.resource.data.userId;
      allow delete: if request.auth != null && request.auth.uid == resource.data.userId;
      // Allow post owners to update their posts
      allow update: if request.auth != null && request.auth.uid == resource.data.userId;
      // Allow any authenticated user to update comment counts (for adding/removing comments)
      allow update: if request.auth != null && 
        ('commentsCount' in request.resource.data || 'lastEngagement' in request.resource.data);
    }
    
    // Comments collection (subcollection of posts)
    match /posts/{postId}/comments/{commentId} {
      allow read: if request.auth != null;
      allow create: if request.auth != null && request.auth.uid == request.resource.data.userId;
      allow update, delete: if request.auth != null && 
        (request.auth.uid == resource.data.userId || 
         request.auth.uid == get(/databases/$(database)/documents/posts/$(postId)).data.userId);
    }
    
    // Comments collection (if used as top-level)
    match /comments/{commentId} {
      allow read: if request.auth != null;
      allow create: if request.auth != null && request.auth.uid == request.resource.data.userId;
      allow update, delete: if request.auth != null && request.auth.uid == resource.data.userId;
    }
    
    // Follows collection
    match /follows/{followId} {
      allow read: if request.auth != null;
      allow create: if request.auth != null && request.auth.uid == request.resource.data.followerId;
      allow delete: if request.auth != null && request.auth.uid == resource.data.followerId;
    }
    
    // UserFollows collection - the actual collection used in the app
    match /userFollows/{followId} {
      allow read: if request.auth != null;
      allow create: if request.auth != null && request.auth.uid == request.resource.data.followerId;
      // Allow deletion by either the follower or the person being followed (needed for account deletion)
      allow delete: if request.auth != null && 
        (request.auth.uid == resource.data.followerId || 
         request.auth.uid == resource.data.targetId ||
         request.auth.uid == resource.data.viewerId);
    }
    
    // Notifications collection
    match /notifications/{notificationId} {
      allow read: if true; // For dev, allow listing/reading
      allow create: if request.auth != null; // Created by server/client actions
      allow update, delete: if request.auth != null && request.resource.data.userId == request.auth.uid;
    }
    
    // Images collection - for Firestore-based image storage
    match /images/{imageId} {
      allow read: if request.auth != null;
      allow create: if request.auth != null && request.auth.uid == request.resource.data.userId;
      allow update, delete: if request.auth != null && request.auth.uid == resource.data.userId;
    }
    
    // Allow reading user counts and public data
    match /public/{document} {
      allow read: if request.auth != null;
      allow write: if request.auth != null; // For system operations
    }
  }
}